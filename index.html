<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ì„±ì  ì¡°íšŒ</title>
  <link rel="icon" href="favicon.png" type="image/png">
  
  <link rel="manifest" href="manifest.json">

  <style>
    /* 1. ê¸°ë³¸ ì„¤ì • ë° ìŠ¤ì™€ì´í”„/ì„ íƒ ë°©ì§€ */
    body { 
      font-family: 'Malgun Gothic', sans-serif; 
      padding: 20px; 
      background-color: #f4f6f8; 
      text-align: center; 
      margin: 0;
      overscroll-behavior-y: contain; 
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .container { background: white; max-width: 500px; margin: 30px auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
    h2 { color: #333; margin-bottom: 25px; }
    p { color: #666; font-size: 14px; margin-bottom: 15px; }
    
    /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    input { 
      width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: 0.3s; 
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    input:focus { border-color: #4285F4; outline: none; }
    input.loading { background-color: #f0f0f0; color: #888; font-style: italic; }
    
    .btn { width: 100%; padding: 14px; background-color: #4285F4; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    .btn:hover { background-color: #3367d6; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; } 
    .btn-secondary { background-color: #777; margin-top: 20px; }
    
    .step-area { display: none; }
    #step1 { display: block; } 
    
    /* ê²°ê³¼ í™”ë©´ í—¤ë” */
    .result-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #4285F4; padding-bottom: 15px; margin-bottom: 15px; }
    .header-text-group { font-size: 20px; font-weight: bold; color: #333; }
    .refresh-btn { background-color: #fff; border: 1px solid #ddd; color: #555; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; margin-left: 10px; white-space: nowrap; flex-shrink: 0; }
    .refresh-btn:hover { background-color: #f1f3f4; border-color: #999; }
    
    /* --- ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ (NEW) --- */
    .accordion-btn {
      background-color: #fff;
      color: #333;
      cursor: pointer;
      padding: 16px 12px;
      width: 100%;
      text-align: left;
      border: none;
      border-bottom: 1px solid #f0f0f0;
      outline: none;
      font-size: 16px;
      font-weight: bold;
      transition: 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2px;
    }
    .accordion-btn:hover { background-color: #f9f9f9; }
    .accordion-btn.active { background-color: #e8f0fe; color: #1967d2; border-bottom: none; }
    
    /* ê³„ì¸µë³„ ë“¤ì—¬ì“°ê¸° ë° ìŠ¤íƒ€ì¼ */
    .level-1 { font-size: 18px; border-left: 6px solid #4285F4; background-color: #fff; } /* í•™ë…„ */
    .level-2 { font-size: 16px; padding-left: 30px; border-left: 6px solid #34a853; background-color: #fafafa; } /* í•™ê¸° */
    .level-3 { font-size: 15px; padding-left: 50px; border-left: 6px solid #fbbc05; background-color: #fcfcfc; } /* ê³¼ëª© */

    /* íŒ¨ë„ (ë‚´ìš© ìˆ¨ê¹€/ë³´ì„) */
    .panel {
      padding: 0;
      background-color: white;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
      border-bottom: 1px solid #eee;
    }
    /* í…Œì´ë¸” ê°ì‹¸ëŠ” ì˜ì—­ */
    .panel-content { padding: 10px 5px; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* í™”ì‚´í‘œ ì•„ì´ì½˜ */
    .arrow::after { content: 'â–¼'; font-size: 12px; float: right; transform: rotate(-90deg); transition: 0.2s; color: #999; }
    .active .arrow::after { transform: rotate(0deg); color: inherit; }

    /* --- ì„±ì  í…Œì´ë¸” ìŠ¤íƒ€ì¼ --- */
    table { width: 100%; border-collapse: collapse; margin-top: 5px; border-radius: 8px; overflow: hidden; font-size: 15px; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #eee; }
    thead tr { background-color: #e0e0e0; color: #333; }
    th:nth-child(1) { text-align: left; width: 60%; padding-left: 15px; }
    th:nth-child(2) { text-align: center; }
    
    .category-row td { font-weight: bold; font-size: 16px; color: #333; text-align: left; padding-left: 10px; border-top: 2px solid #fff; }
    .bg-exam { background-color: #e6f4ea; } 
    .bg-perform { background-color: #fce8e6; } 
    .bg-default { background-color: #f1f3f4; } 
    
    .item-row td:nth-child(1) { padding-left: 25px; color: #555; text-align: left; }
    .item-row td:nth-child(2) { text-align: center; font-weight: bold; color: #333; }
    .item-row:last-child td { border-bottom: none; }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal-box { background: white; padding: 30px 25px; border-radius: 15px; width: 85%; max-width: 380px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.25s; display: flex; flex-direction: column; gap: 15px; }
    .modal-title { font-size: 19px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .modal-msg { font-size: 15px; color: #555; line-height: 1.6; word-break: keep-all; }
    .modal-btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
    .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .modal-btn.confirm { background-color: #4285F4; color: white; }
    .modal-btn.cancel { background-color: #e0e0e0; color: #555; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div class="container">
    <h2 id="mainTitle">ì„±ì  ì¡°íšŒ</h2>
    <div id="step1" class="step-area">
      <p>ë³¸ì¸ í™•ì¸ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
      <input type="text" id="inputIds" placeholder="í•™ë²ˆ (ì˜ˆ: 1129)" onblur="autoFill('id')">
      <input type="text" id="inputName" placeholder="ì´ë¦„ (ì˜ˆ: ê´‘ë‚¨ì´)" onblur="autoFill('name')">
      <button id="btnStep1" onclick="processStep1()" class="btn">í™•ì¸í•˜ê¸°</button>
    </div>
    <div id="step2-register" class="step-area">
      <h3 style="color:#4285F4">ğŸ” ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h3>
      <p>ì²˜ìŒ ì ‘ì†í•˜ì…¨êµ°ìš”!<br>ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
      <input type="password" id="regPw1" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
      <input type="password" id="regPw2" placeholder="ë¹„ë°€ë²ˆí˜¸ í•œë²ˆ ë” ì…ë ¥">
      <button onclick="processRegister()" class="btn">ì„¤ì •í•˜ê³  ì„±ì  ì¡°íšŒí•˜ê¸°</button>
    </div>
    <div id="step2-login" class="step-area">
      <h3 style="color:#4285F4">ğŸ”’ ë¡œê·¸ì¸</h3>
      <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
      <button onclick="processLogin()" class="btn">ì„±ì  í™•ì¸í•˜ê¸°</button>
    </div>
    <div id="step3-result" class="step-area"></div>
  </div>

  <div id="customModal" class="modal-overlay">
    <div class="modal-box">
      <div id="modalTitle" class="modal-title">ì•Œë¦¼</div>
      <div id="modalMsg" class="modal-msg">ë‚´ìš©</div>
      <div class="modal-btn-group">
        <button id="modalBtnCancel" class="modal-btn cancel" style="display:none;" onclick="closeModal()">ì·¨ì†Œ</button>
        <button id="modalBtnConfirm" class="modal-btn confirm" onclick="closeModal()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDzAYguXSjmjNJFEYPplLKUj_twhOO0Llk",
      authDomain: "record-99cf0.firebaseapp.com",
      databaseURL: "https://record-99cf0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "record-99cf0",
      storageBucket: "record-99cf0.firebasestorage.app",
      messagingSenderId: "127235673442",
      appId: "1:127235673442:web:7ebee7c66698c81b70703b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const MASTER_PW = "rhkdska25"; 

    var currentId = "";
    var currentName = "";
    var globalScoreData = {};
    var onModalConfirm = null;
    var isAutoFilling = false;
    var fetchedStudentData = null; 

    // ìš°í´ë¦­ ë°©ì§€
    document.addEventListener('contextmenu', function(event) { event.preventDefault(); });

    // History State ì´ˆê¸°í™”
    window.addEventListener('load', function() {
        history.replaceState({ step: 'step1' }, 'step1', '');
    });

    // ë’¤ë¡œê°€ê¸°(popstate) ì´ë²¤íŠ¸
    window.onpopstate = function(event) {
        document.querySelectorAll('.step-area').forEach(el => el.style.display = 'none');
        document.getElementById('step3-result').style.display = 'none';
        
        var showMainTitle = true;
        if (event.state && event.state.step) {
            var target = event.state.step;
            if (target === 'step3') {
                document.getElementById('step3-result').style.display = 'block';
                document.querySelector('.container').style.maxWidth = 'none'; 
                showMainTitle = false;
            } else if (target === 'step2-login' || target === 'step2-register') {
                document.getElementById(target).style.display = 'block';
                document.querySelector('.container').style.maxWidth = '500px';
            } else {
                document.getElementById('step1').style.display = 'block';
                document.querySelector('.container').style.maxWidth = '500px';
            }
        } else {
            document.getElementById('step1').style.display = 'block';
            document.querySelector('.container').style.maxWidth = '500px';
        }
        document.getElementById('mainTitle').style.display = showMainTitle ? 'block' : 'none';
    };

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function showAlert(title, msg, callback) {
      document.getElementById('modalTitle').innerText = title;
      document.getElementById('modalMsg').innerHTML = msg.replace(/\n/g, "<br>");
      document.getElementById('modalBtnCancel').style.display = 'none';
      document.getElementById('modalBtnConfirm').innerText = "í™•ì¸";
      onModalConfirm = function() { closeModal(); if(callback) callback(); };
      document.getElementById('customModal').style.display = 'flex';
    }
    function showConfirm(title, msg, yesCallback) {
      document.getElementById('modalTitle').innerText = title;
      document.getElementById('modalMsg').innerHTML = msg;
      document.getElementById('modalBtnCancel').style.display = 'block';
      document.getElementById('modalBtnConfirm').innerText = "ì„¤ì •í•˜ê¸°";
      onModalConfirm = function() { closeModal(); if(yesCallback) yesCallback(); };
      document.getElementById('customModal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('customModal').style.display = 'none'; }
    document.getElementById('modalBtnConfirm').onclick = function() { if (onModalConfirm) onModalConfirm(); else closeModal(); };

    // ìë™ì™„ì„± (AutoFill)
    function autoFill(type) {
      if (isAutoFilling) return;
      var inputIds = document.getElementById('inputIds');
      var inputName = document.getElementById('inputName');
      var rawVal = (type === 'id') ? inputIds.value : inputName.value;
      var searchVal = rawVal ? rawVal.replace(/@/g, "").trim() : "";
      if (searchVal === "") return;
      
      var targetInput = (type === 'id') ? inputName : inputIds;
      var btn = document.getElementById('btnStep1');
      if (targetInput.value !== "" && targetInput.value !== "ìë™ ìƒì„±ì¤‘...") return;

      isAutoFilling = true;
      targetInput.classList.add('loading');
      targetInput.value = "ìë™ ìƒì„±ì¤‘..."; 
      btn.disabled = true; btn.innerHTML = "ì¡°íšŒ ì¤‘...";

      var promise;
      if (type === 'id') {
        promise = db.ref('students/' + searchVal).once('value').then(snap => {
           return snap.exists() ? { success: true, result: snap.val().name } : { success: false };
        });
      } else {
        promise = db.ref('students').orderByChild('name').equalTo(searchVal).limitToFirst(1).once('value').then(snap => {
           if (snap.exists()) {
             var foundId = Object.keys(snap.val())[0];
             return { success: true, result: foundId };
           } else { return { success: false }; }
        });
      }

      promise.then(function(response) {
        targetInput.classList.remove('loading');
        isAutoFilling = false;
        btn.disabled = false; btn.innerHTML = "í™•ì¸í•˜ê¸°";
        if (response.success) {
          targetInput.value = response.result;
          btn.focus(); 
        } else {
          targetInput.value = "";
          targetInput.blur();
        }
      });
    }

    // Step 1 ì²˜ë¦¬
    function processStep1() {
      if (isAutoFilling) return;
      var rawId = document.getElementById('inputIds').value;
      var rawName = document.getElementById('inputName').value;
      if (rawId === "ìë™ ìƒì„±ì¤‘..." || rawName === "ìë™ ìƒì„±ì¤‘...") return;
      if(!rawId || !rawName) { showAlert("ì…ë ¥ ì˜¤ë¥˜", "í•™ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
      
      var isAdminMode = (rawId.indexOf("@") > -1) || (rawName.indexOf("@") > -1);
      var id = rawId.replace(/@/g, "").trim();
      var name = rawName.replace(/@/g, "").trim();

      if (isAdminMode) {
        currentId = id; currentName = name;
        document.getElementById('btnStep1').innerHTML = "ê´€ë¦¬ì ê¶Œí•œ ì¡°íšŒ ì¤‘...";
        loadScoreAndShow("##ADMIN_FREE_PASS##"); 
        return; 
      }

      var btn = document.getElementById('btnStep1');
      btn.innerHTML = "í™•ì¸ ì¤‘..."; btn.disabled = true;
      
      db.ref('students/' + id).once('value').then(function(snapshot) {
        btn.innerHTML = "í™•ì¸í•˜ê¸°"; btn.disabled = false;
        if (snapshot.exists()) {
          var data = snapshot.val();
          if (data.name !== name) {
            showAlert("ì •ë³´ ë¶ˆì¼ì¹˜", "ì¼ì¹˜í•˜ëŠ” í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>í•™ë²ˆê³¼ ì´ë¦„ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
            return;
          }
          currentId = id; currentName = name;
          fetchedStudentData = data;
          
          document.getElementById('step1').style.display = 'none';
          
          if (data.pw && String(data.pw).trim() !== "") {
            document.getElementById('step2-login').style.display = 'block';
            document.getElementById('loginPw').focus();
            history.pushState({ step: 'step2-login' }, 'login', '');
          } else {
            document.getElementById('step2-register').style.display = 'block';
            document.getElementById('regPw1').focus();
            history.pushState({ step: 'step2-register' }, 'register', '');
          }
        } else {
          showAlert("ì •ë³´ ë¶ˆì¼ì¹˜", "ì¼ì¹˜í•˜ëŠ” í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>í•™ë²ˆê³¼ ì´ë¦„ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
      });
    }

    // ë¹„ë°€ë²ˆí˜¸ ë“±ë¡
    function processRegister() {
      var pw1 = document.getElementById('regPw1').value;
      var pw2 = document.getElementById('regPw2').value;
      if (!pw1 || pw1.length < 4) { showAlert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜", "ë¹„ë°€ë²ˆí˜¸ëŠ” 4ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }
      if (pw1 !== pw2) { showAlert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜", "ì…ë ¥í•œ ë‘ ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ë‹¤ë¦…ë‹ˆë‹¤."); return; }
      
      var msg = "ë¹„ë°€ë²ˆí˜¸ë¥¼ <span style='color:#d93025; font-weight:bold; font-size:18px;'>" + pw1 + "</span> (ìœ¼)ë¡œ<br>ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
      showConfirm("ë¹„ë°€ë²ˆí˜¸ ì„¤ì •", msg, function() { 
        db.ref('students/' + currentId).update({ pw: pw1 }).then(function() {
           if(fetchedStudentData) fetchedStudentData.pw = pw1;
           showAlert("ì„¤ì • ì™„ë£Œ", "ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì„±ì ì„ ì¡°íšŒí•©ë‹ˆë‹¤.", function() { loadScoreAndShow(pw1); });
        }).catch(function(err) { showAlert("ì˜¤ë¥˜", "ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); });
      });
    }

    // ë¡œê·¸ì¸
    function processLogin() {
      var pw = document.getElementById('loginPw').value;
      if (!pw) { showAlert("ì…ë ¥ ì˜¤ë¥˜", "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
      loadScoreAndShow(pw);
    }

    // ë°ì´í„° ë¡œë“œ
    function loadScoreAndShow(pw) {
      if (!fetchedStudentData) {
         db.ref('students/' + currentId).once('value').then(function(snap){
            if(snap.exists()) {
               fetchedStudentData = snap.val();
               verifyAndRender(pw);
            } else {
               showAlert("ì˜¤ë¥˜", "ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
               resetAll();
            }
         });
      } else { verifyAndRender(pw); }
    }

    // [ì¤‘ìš”] ë¡œê·¸ì¸ ê²€ì¦ ë° 3ë‹¨ ì•„ì½”ë””ì–¸ ë Œë”ë§ ì‹œì‘
    function verifyAndRender(pw) {
       var isMaster = (String(pw).trim() === MASTER_PW || String(pw) === "##ADMIN_FREE_PASS##");
       var storedPw = fetchedStudentData.pw ? String(fetchedStudentData.pw).trim() : "";
       var pwMatch = (storedPw === String(pw).trim());

       if (pwMatch || isMaster) {
         document.querySelector('.container').style.maxWidth = '500px';
         document.querySelectorAll('.step-area').forEach(el => el.style.display = 'none');
         document.getElementById('mainTitle').style.display = 'none';
         document.getElementById('step3-result').style.display = 'block';
         
         history.pushState({ step: 'step3' }, 'result', '');

         globalScoreData = fetchedStudentData.scores || {};
         
         // 1. í—¤ë” (í•™ìƒì´ë¦„, ìƒˆë¡œê³ ì¹¨)
         var html = '<div class="result-header">';
         html += '<div class="header-text-group"><span style="color:#4285F4">' + currentName + '</span> ë‹˜ì˜ ì„±ì í‘œ</div>';
         html += '<button class="refresh-btn" onclick="location.reload()">ğŸ”„ ì²˜ìŒìœ¼ë¡œ</button>';
         html += '</div>';
         
         // 2. ì•„ì½”ë””ì–¸ ì˜ì—­ ìƒì„±
         html += '<div id="accordionArea"></div>';
         html += '<button class="btn btn-secondary" onclick="resetAll()">ë¡œê·¸ì•„ì›ƒ</button>';
         
         document.getElementById('step3-result').innerHTML = html;
         
         // 3. ë°ì´í„° íŠ¸ë¦¬ ë Œë”ë§ í˜¸ì¶œ
         renderAccordionTree(globalScoreData, document.getElementById('accordionArea'));

       } else {
         showAlert("ì¡°íšŒ ì‹¤íŒ¨", "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
         var btn = document.getElementById('btnStep1');
         btn.innerHTML = "í™•ì¸í•˜ê¸°"; btn.disabled = false;
         document.getElementById('step2-login').style.display = 'block';
         document.getElementById('loginPw').value = "";
       }
    }

    // 3ë‹¨ ì•„ì½”ë””ì–¸ ìƒì„± í•¨ìˆ˜ (í•™ë…„ -> í•™ê¸° -> ê³¼ëª©)
    function renderAccordionTree(data, container) {
      if (!data || Object.keys(data).length === 0) {
        container.innerHTML = '<p style="padding:20px; text-align:center;">ë“±ë¡ëœ ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      // 1ë‹¨: í•™ë…„
      Object.keys(data).forEach(function(grade) {
        var gradeBtn = createAccordionBtn(grade, 'level-1');
        var gradePanel = document.createElement('div');
        gradePanel.className = 'panel';
        
        container.appendChild(gradeBtn);
        container.appendChild(gradePanel);

        gradeBtn.onclick = function() { togglePanel(this, gradePanel); };

        // 2ë‹¨: í•™ê¸°
        var semesterData = data[grade];
        Object.keys(semesterData).forEach(function(semester) {
          var semesterBtn = createAccordionBtn(semester, 'level-2');
          var semesterPanel = document.createElement('div');
          semesterPanel.className = 'panel';
          
          gradePanel.appendChild(semesterBtn);
          gradePanel.appendChild(semesterPanel);

          semesterBtn.onclick = function() { togglePanel(this, semesterPanel); };

          // 3ë‹¨: ê³¼ëª©
          var subjectData = semesterData[semester];
          Object.keys(subjectData).forEach(function(subject) {
             var subjectBtn = createAccordionBtn(subject, 'level-3');
             var subjectPanel = document.createElement('div');
             subjectPanel.className = 'panel';
             
             semesterPanel.appendChild(subjectBtn);
             semesterPanel.appendChild(subjectPanel);

             subjectBtn.onclick = function() { togglePanel(this, subjectPanel); };

             // 4. ì ìˆ˜ í…Œì´ë¸” ì‚½ì…
             var tableContainer = document.createElement('div');
             tableContainer.className = 'panel-content';
             tableContainer.innerHTML = getTableHTML(subjectData[subject]);
             subjectPanel.appendChild(tableContainer);
          });
        });
      });
    }

    // ë²„íŠ¼ ìƒì„± í—¬í¼
    function createAccordionBtn(text, levelClass) {
      var btn = document.createElement('button');
      btn.className = 'accordion-btn ' + levelClass;
      btn.innerHTML = '<span>' + text + '</span><span class="arrow"></span>';
      return btn;
    }

    // íŒ¨ë„ í† ê¸€ í•¨ìˆ˜ (ì¤‘ì²© ë†’ì´ ì²˜ë¦¬ í¬í•¨)
    function togglePanel(btn, panel) {
      btn.classList.toggle("active");
      if (panel.style.maxHeight) {
        panel.style.maxHeight = null;
      } else {
        panel.style.maxHeight = panel.scrollHeight + "px";
        
        // ì¤‘ìš”: ë‚´ë¶€ íŒ¨ë„ì´ ì—´ë¦´ ë•Œ ë¶€ëª¨ íŒ¨ë„ì˜ ë†’ì´ ì œí•œì„ í’€ì–´ì¤˜ì•¼ ì˜ë¦¬ì§€ ì•ŠìŒ
        var parentPanel = panel.parentElement;
        if(parentPanel && parentPanel.classList.contains('panel')) {
            parentPanel.style.maxHeight = "none"; 
        }
        var grandParent = parentPanel ? parentPanel.parentElement : null;
        if(grandParent && grandParent.classList.contains('panel')) {
            grandParent.style.maxHeight = "none";
        }
      }
    }

    // ì ìˆ˜ í…Œì´ë¸” HTML ìƒì„± (ì´ì „ renderTable ë¡œì§ ë³€í™˜)
    function getTableHTML(categoryList) {
      var html = '<table><thead><tr><th>í‰ê°€</th><th>ì ìˆ˜</th></tr></thead><tbody>';
      
      if (categoryList && categoryList.length > 0) {
        for (var k = 0; k < categoryList.length; k++) {
          var category = categoryList[k].category; 
          var items = categoryList[k].items;       
          var categoryScore = ""; 
          var displayItems = []; 
          
          for (var i = 0; i < items.length; i++) {
            if (items[i].item.replace(/\s/g, "") === "í•©ê³„") { categoryScore = items[i].score; } 
            else { displayItems.push(items[i]); }
          }

          var bgClass = 'bg-default';
          if (category.indexOf('ê³ ì‚¬') > -1 || category.indexOf('ì‹œí—˜') > -1) bgClass = 'bg-exam';
          else if (category.indexOf('ìˆ˜í–‰') > -1) bgClass = 'bg-perform';

          html += '<tr class="category-row ' + bgClass + '">';
          html += '  <td>' + category + '</td>';
          html += '  <td style="text-align:center;">' + categoryScore + '</td>'; 
          html += '</tr>';
          
          for (var i = 0; i < displayItems.length; i++) {
            var itemName = displayItems[i].item;
            var itemScore = displayItems[i].score;
            var scoreStyle = "";
            if (itemName.indexOf("ê°ê´€ì‹") > -1 || itemName.indexOf("ì£¼ê´€ì‹") > -1) {
               scoreStyle = 'style="font-weight: normal; color: #555;"'; 
            }
            html += '<tr class="item-row"><td>' + itemName + '</td><td ' + scoreStyle + '>' + itemScore + '</td></tr>';
          }
        }
      } else {
        html += '<tr><td colspan="2" style="text-align:center; padding: 20px;">ê²°ê³¼ ì—†ìŒ</td></tr>';
      }
      html += '</tbody></table>';
      return html;
    }

    function resetAll() { location.href = location.href; }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ'))
        .catch(() => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨'));
    }
  </script>
  
</body>
</html>
