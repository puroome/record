<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì„±ì  ì¡°íšŒ ì‹œìŠ¤í…œ</title>
  <style>
    /* ê¸°ë³¸ ë””ìì¸ ì„¤ì • */
    body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background-color: #f4f6f8; text-align: center; margin: 0; }
    .container { background: white; max-width: 500px; margin: 30px auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    h2 { color: #333; margin-bottom: 25px; }
    p { color: #666; font-size: 14px; margin-bottom: 15px; }

    /* ì…ë ¥ì°½ ë° ë²„íŠ¼ */
    input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    input:focus { border-color: #4285F4; outline: none; }
    
    .btn { width: 100%; padding: 14px; background-color: #4285F4; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    .btn:hover { background-color: #3367d6; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; } 
    .btn-secondary { background-color: #777; margin-top: 10px; }

    /* í™”ë©´ ì „í™˜ìš© */
    .step-area { display: none; }
    #step1 { display: block; } 

    /* ê²°ê³¼ í™”ë©´ */
    .result-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #4285F4; padding-bottom: 15px; margin-bottom: 15px; }
    .header-text-group { display: flex; align-items: center; font-size: 18px; font-weight: bold; color: #333; flex-wrap: wrap; gap: 5px; }
    #subjectSelect { font-size: 18px; padding: 5px; border: 2px solid #4285F4; border-radius: 6px; background-color: #e8f0fe; color: #333; font-weight: bold; cursor: pointer; }
    
    /* í…Œì´ë¸” */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; font-size: 15px; }
    thead tr { background-color: #e0e0e0; color: #333; }
    th:nth-child(1) { text-align: left; width: 60%; padding-left: 20px; }
    
    .category-row td { font-weight: bold; font-size: 16px; color: #333; text-align: left; padding-left: 15px; border-top: 2px solid #fff; }
    .bg-exam { background-color: #e6f4ea; } 
    .bg-perform { background-color: #fce8e6; } 
    .bg-default { background-color: #f1f3f4; } 
    .item-row td:nth-child(1) { padding-left: 30px; color: #555; text-align: left; }
    .item-row td:nth-child(2) { text-align: center; font-weight: bold; color: #333; }

    /* ëª¨ë‹¬ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 999; }
    .modal-box { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; font-weight: bold; }
    .confirm { background-color: #4285F4; color: white; }
    .cancel { background-color: #eee; color: #555; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

  <div class="container">
    <h2 id="mainTitle">ì„±ì  ì¡°íšŒ</h2>
    
    <div id="step1" class="step-area">
      <p>í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="text" id="inputIds" placeholder="í•™ë²ˆ (ì˜ˆ: 1101)" onblur="autoFillByInfo('id')">
      <input type="text" id="inputName" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)" onblur="autoFillByInfo('name')">
      <button id="btnStep1" onclick="checkUser()" class="btn">í™•ì¸í•˜ê¸°</button>
    </div>

    <div id="step2-register" class="step-area">
      <h3 style="color:#4285F4">ğŸ” ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h3>
      <p>ì²« ë°©ë¬¸ì´ì‹œêµ°ìš”!<br>ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
      <input type="password" id="regPw1" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
      <input type="password" id="regPw2" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
      <button onclick="registerPassword()" class="btn">ì„¤ì • ì™„ë£Œ</button>
    </div>

    <div id="step2-login" class="step-area">
      <h3 style="color:#4285F4">ğŸ”’ ë¡œê·¸ì¸</h3>
      <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
      <button onclick="login()" class="btn">ì„±ì  í™•ì¸</button>
    </div>

    <div id="step3-result" class="step-area"></div>
  </div>

  <div id="customModal" class="modal-overlay">
    <div class="modal-box">
      <h3 id="modalTitle" style="margin-top:0">ì•Œë¦¼</h3>
      <p id="modalMsg">ë‚´ìš©</p>
      <button id="modalBtnCancel" class="modal-btn cancel" onclick="closeModal()">ì·¨ì†Œ</button>
      <button id="modalBtnConfirm" class="modal-btn confirm">í™•ì¸</button>
    </div>
  </div>

  <script>
    // 1. Firebase ì„¤ì • (ì„ ìƒë‹˜ì´ ì£¼ì‹  í‚¤ ì ìš©ë¨)
    const firebaseConfig = {
      apiKey: "AIzaSyDzAYguXSjmjNJFEYPplLKUj_twhOO0Llk",
      authDomain: "record-99cf0.firebaseapp.com",
      databaseURL: "https://record-99cf0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "record-99cf0",
      storageBucket: "record-99cf0.firebasestorage.app",
      messagingSenderId: "127235673442",
      appId: "1:127235673442:web:7ebee7c66698c81b70703b"
    };

    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const MASTER_PW = "rhkdska25"; // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (í•„ìš” ì‹œ ìˆ˜ì •)

    // ì „ì—­ ë³€ìˆ˜
    let currentId = "";
    let currentName = "";
    let fetchedStudentData = null;
    let onModalConfirm = null;

    /* --- ê¸°ëŠ¥ 1: ìë™ì™„ì„± (í•™ë²ˆ<->ì´ë¦„) --- */
    function autoFillByInfo(type) {
      const idVal = document.getElementById('inputIds').value.trim();
      const nameVal = document.getElementById('inputName').value.trim();
      
      // ì´ë¯¸ ë‘˜ ë‹¤ ì°¨ìˆê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ ì¤‘ë‹¨
      if ((idVal && nameVal) || (!idVal && !nameVal)) return;

      const targetInput = type === 'id' ? document.getElementById('inputName') : document.getElementById('inputIds');
      const searchVal = type === 'id' ? idVal : nameVal;

      targetInput.placeholder = "ê²€ìƒ‰ ì¤‘...";
      
      if (type === 'id') {
        // í•™ë²ˆìœ¼ë¡œ ì´ë¦„ ì°¾ê¸° (IDê°€ í‚¤ì´ë¯€ë¡œ ë°”ë¡œ ì¡°íšŒ)
        db.ref('students/' + idVal).once('value').then(snapshot => {
          if (snapshot.exists()) {
            targetInput.value = snapshot.val().name;
          } else {
            targetInput.placeholder = "ì •ë³´ ì—†ìŒ";
          }
        });
      } else {
        // ì´ë¦„ìœ¼ë¡œ í•™ë²ˆ ì°¾ê¸° (Query ì‚¬ìš©)
        db.ref('students').orderByChild('name').equalTo(nameVal).limitToFirst(1).once('value').then(snapshot => {
          if (snapshot.exists()) {
            // ê²°ê³¼ ê°ì²´ì˜ ì²« ë²ˆì§¸ í‚¤(í•™ë²ˆ)ë¥¼ ê°€ì ¸ì˜´
            const foundId = Object.keys(snapshot.val())[0];
            targetInput.value = foundId;
          } else {
            targetInput.placeholder = "ì •ë³´ ì—†ìŒ";
          }
        });
      }
    }

    /* --- ê¸°ëŠ¥ 2: í•™ìƒ ì •ë³´ í™•ì¸ (Step 1) --- */
    function checkUser() {
      const id = document.getElementById('inputIds').value.trim();
      const name = document.getElementById('inputName').value.trim();

      if (!id || !name) { showAlert("ì…ë ¥ ì˜¤ë¥˜", "í•™ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }

      // ê´€ë¦¬ì í”„ë¦¬íŒ¨ìŠ¤ ì²´í¬
      if (id.includes("@") || name.includes("@")) {
         currentId = id.replace("@",""); 
         currentName = name.replace("@","");
         showResultView("##ADMIN##"); // ê°•ì œ ì§„ì…
         return;
      }

      // Firebaseì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const btn = document.getElementById('btnStep1');
      btn.disabled = true; btn.innerText = "ì¡°íšŒ ì¤‘...";

      db.ref('students/' + id).once('value').then(snapshot => {
        btn.disabled = false; btn.innerText = "í™•ì¸í•˜ê¸°";
        
        if (snapshot.exists()) {
          const data = snapshot.val();
          if (data.name !== name) {
            showAlert("ì •ë³´ ë¶ˆì¼ì¹˜", "í•™ë²ˆê³¼ ì´ë¦„ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
          }
          
          // ì •ë³´ ì¼ì¹˜ -> ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
          currentId = id;
          currentName = name;
          fetchedStudentData = data;

          // í™”ë©´ ì „í™˜
          document.getElementById('step1').style.display = 'none';
          if (data.pw && data.pw !== "") {
            document.getElementById('step2-login').style.display = 'block';
            document.getElementById('loginPw').focus();
          } else {
            document.getElementById('step2-register').style.display = 'block';
            document.getElementById('regPw1').focus();
          }

        } else {
          showAlert("ì˜¤ë¥˜", "í•´ë‹¹ í•™ë²ˆì˜ í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
      }).catch(err => {
        console.error(err);
        btn.disabled = false; btn.innerText = "í™•ì¸í•˜ê¸°";
        showAlert("í†µì‹  ì˜¤ë¥˜", "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      });
    }

    /* --- ê¸°ëŠ¥ 3: ë¹„ë°€ë²ˆí˜¸ ë“±ë¡ --- */
    function registerPassword() {
      const pw1 = document.getElementById('regPw1').value;
      const pw2 = document.getElementById('regPw2').value;

      if (pw1.length < 4) { showAlert("ì˜¤ë¥˜", "ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }
      if (pw1 !== pw2) { showAlert("ì˜¤ë¥˜", "ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ë‹¤ë¦…ë‹ˆë‹¤."); return; }

      showConfirm("ì„¤ì • í™•ì¸", `ë¹„ë°€ë²ˆí˜¸ë¥¼ <b>${pw1}</b>ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, function() {
        // Firebase ì—…ë°ì´íŠ¸
        db.ref('students/' + currentId).update({ pw: pw1 }).then(() => {
          showAlert("ì™„ë£Œ", "ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", () => {
             // ë°ì´í„° ê°±ì‹  í›„ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ
             fetchedStudentData.pw = pw1;
             showResultView(pw1);
          });
        });
      });
    }

    /* --- ê¸°ëŠ¥ 4: ë¡œê·¸ì¸ --- */
    function login() {
      const inputPw = document.getElementById('loginPw').value;
      if (!inputPw) return;

      if (inputPw === fetchedStudentData.pw || inputPw === MASTER_PW) {
        showResultView(inputPw);
      } else {
        showAlert("ë¡œê·¸ì¸ ì‹¤íŒ¨", "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
      }
    }

    /* --- ê¸°ëŠ¥ 5: ê²°ê³¼ í™”ë©´ ë Œë”ë§ --- */
    function showResultView(pw) {
      const container = document.querySelector('.container');
      const step3 = document.getElementById('step3-result');
      
      // UI ì •ë¦¬
      document.querySelectorAll('.step-area').forEach(el => el.style.display = 'none');
      document.getElementById('mainTitle').style.display = 'none';
      step3.style.display = 'block';
      
      // ì ìˆ˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (fetchedStudentDataì— ì´ë¯¸ ìˆìŒ)
      const scores = fetchedStudentData.scores || {};
      const subjects = Object.keys(scores);

      let html = `
        <div class="result-header">
          <div class="header-text-group">
            <span style="color:#4285F4">${fetchedStudentData.name}</span> ë‹˜ì˜
            <select id="subjectSelect" onchange="renderTable()">`;
      
      subjects.forEach(sub => {
        html += `<option value="${sub}">${sub}</option>`;
      });

      html += `</select> ì„±ì 
          </div>
          <button class="btn-secondary" style="margin:0; padding:5px 10px; font-size:12px;" onclick="location.reload()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div id="tableArea"></div>
      `;

      step3.innerHTML = html;
      
      // í…Œì´ë¸” ê·¸ë¦¬ê¸° í•¨ìˆ˜ ì „ì—­ ë“±ë¡
      window.renderTable = function() {
        const selectedSub = document.getElementById('subjectSelect').value;
        const categoryList = scores[selectedSub];
        const tableArea = document.getElementById('tableArea');

        let tbl = `<table><thead><tr><th>í‰ê°€ í•­ëª©</th><th>ì ìˆ˜</th></tr></thead><tbody>`;

        if (categoryList) {
          categoryList.forEach(catBlock => {
            // ì¹´í…Œê³ ë¦¬ í—¤ë” (ì¤‘ê°„ê³ ì‚¬, ìˆ˜í–‰í‰ê°€ ë“±)
            let bgClass = 'bg-default';
            if (catBlock.category.includes('ê³ ì‚¬') || catBlock.category.includes('ì‹œí—˜')) bgClass = 'bg-exam';
            else if (catBlock.category.includes('ìˆ˜í–‰')) bgClass = 'bg-perform';

            // í•©ê³„ ì ìˆ˜ ì°¾ê¸°
            let catTotal = "";
            const detailItems = [];
            
            catBlock.items.forEach(item => {
              if (item.item.replace(/\s/g,"") === "í•©ê³„") catTotal = item.score;
              else detailItems.push(item);
            });

            tbl += `<tr class="category-row ${bgClass}">
                      <td>${catBlock.category}</td>
                      <td style="text-align:center;">${catTotal}</td>
                    </tr>`;

            // ì„¸ë¶€ í•­ëª©
            detailItems.forEach(d => {
              let style = "";
              if (d.item.includes("ê°ê´€ì‹") || d.item.includes("ì£¼ê´€ì‹")) style = "color:#888; font-weight:normal;";
              tbl += `<tr class="item-row">
                        <td>${d.item}</td>
                        <td style="${style}">${d.score}</td>
                      </tr>`;
            });
          });
        } else {
          tbl += `<tr><td colspan="2">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        }
        tbl += `</tbody></table>`;
        tableArea.innerHTML = tbl;
      };

      // ì´ˆê¸° í…Œì´ë¸” ë Œë”ë§
      if (subjects.length > 0) renderTable();
      else step3.innerHTML += "<p>ë“±ë¡ëœ ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    }

    /* --- ìœ í‹¸ë¦¬í‹°: ëª¨ë‹¬ì°½ --- */
    function showAlert(title, msg, callback) {
      document.getElementById('modalTitle').innerText = title;
      document.getElementById('modalMsg').innerHTML = msg.replace(/\n/g, "<br>");
      document.getElementById('modalBtnCancel').style.display = 'none';
      document.getElementById('modalBtnConfirm').onclick = function() { closeModal(); if(callback) callback(); };
      document.getElementById('customModal').style.display = 'flex';
    }
    function showConfirm(title, msg, yesCallback) {
      document.getElementById('modalTitle').innerText = title;
      document.getElementById('modalMsg').innerHTML = msg.replace(/\n/g, "<br>");
      document.getElementById('modalBtnCancel').style.display = 'inline-block';
      document.getElementById('modalBtnConfirm').onclick = function() { closeModal(); if(yesCallback) yesCallback(); };
      document.getElementById('customModal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('customModal').style.display = 'none'; }
  </script>
</body>
</html>
